(window.webpackJsonp=window.webpackJsonp||[]).push([[104],{427:function(s,t,a){"use strict";a.r(t);var e=a(8),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mysql优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql优化"}},[s._v("#")]),s._v(" MySQL优化")]),s._v(" "),t("h2",{attrs:{id:"_1-数据库是如何实现分页的-假设有100万条数据如何优化分页查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-数据库是如何实现分页的-假设有100万条数据如何优化分页查询"}},[s._v("#")]),s._v(" 1. 数据库是如何实现分页的，假设有100万条数据如何优化分页查询")]),s._v(" "),t("p",[s._v("分页查询的语句")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("offset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFFSET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("offset")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("分页查询方式会从数据库第一条记录开始扫描，所以越往后，查询速度越慢，而且查询的数据越多，也会拖慢总查询速度。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tbl "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 很快，0.01s")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tbl "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("90000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从9万条开始分页，很慢，9s")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("优化：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("使用子查询结合id进行优化，当id是连续递增的时候，根据查询的页数和查询的记录数可以算出查询id的范围。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tbl \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tbl "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("order")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" order_id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("通过索引进行查询分页。")])])]),s._v(" "),t("h2",{attrs:{id:"_2-如何优化mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-如何优化mysql"}},[s._v("#")]),s._v(" 2. 如何优化MySQL")]),s._v(" "),t("ol",[t("li",[s._v("存储引擎的选择：根据不同的需求选择不同的存储引擎\n"),t("ol",[t("li",[s._v("Innodb：数据完整性，支持事务，适用于高并发、擅长更新和删除。（财务系统、经常修改删除、需要事务回滚）")]),s._v(" "),t("li",[s._v("MyISAM：删除查询及插入。（微博插入、查询，很少更新和删除，数据完整性没有太强烈要求）。")])])]),s._v(" "),t("li",[s._v("字段类型的选择")]),s._v(" "),t("li",[s._v("范式与逆范式")]),s._v(" "),t("li",[s._v("索引，提高查询速度")])]),s._v(" "),t("h2",{attrs:{id:"_3-索引设计规范"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-索引设计规范"}},[s._v("#")]),s._v(" 3. 索引设计规范")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("选择合适的字段")]),s._v(" "),t("ul",[t("li",[s._v("不为NULL")]),s._v(" "),t("li",[s._v("频繁查询排序的")]),s._v(" "),t("li",[s._v("频繁更新的慎重建立索引")])])]),s._v(" "),t("li",[t("p",[s._v("尽可能建立联合索引，索引对应B+树，索引多了，占用空间。")])]),s._v(" "),t("li",[t("p",[s._v("避免冗余索引，能够命中索引(a, b)就肯定能命中索引(a) ，那么索引(a)就是冗余索引。")])]),s._v(" "),t("li",[t("p",[s._v("考虑在字符串类型的字段上使用前缀索引代替普通索引。")])])]),s._v(" "),t("h2",{attrs:{id:"_4-sql开发规范"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-sql开发规范"}},[s._v("#")]),s._v(" 4. SQL开发规范")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("避免使用前置 %，索引失效")])]),s._v(" "),t("li",[t("p",[s._v("禁止使用 SELECT * 必须使用 SELECT <字段列表> 查询")]),s._v(" "),t("ul",[t("li",[s._v("SELECT * 消耗更多的 CPU 和 IO 以网络带宽资源")]),s._v(" "),t("li",[s._v("SELECT * 无法使用覆盖索引")]),s._v(" "),t("li",[s._v("SELECT <字段列表> 可减少表结构变更带来的影响")])])]),s._v(" "),t("li",[t("p",[s._v("避免使用子查询，可以把子查询优化为 join 操作")]),s._v(" "),t("ul",[t("li",[s._v("子查询会产生大量的临时表也没有索引，所以会消耗过多的 CPU 和 IO 资源")])])]),s._v(" "),t("li",[t("p",[s._v("避免使用 JOIN 关联太多的表")]),s._v(" "),t("ul",[t("li",[s._v("多关联（join）一个表，就会多分配一个关联缓存，占用内存")]),s._v(" "),t("li",[s._v("产生临时表操作，影响查询效率")])])]),s._v(" "),t("li",[t("p",[s._v("or 的查询尽量用 union 或者 union all 代替（在确认没有重复数据或者不用剔除重复数据时，union all 会更好）")])]),s._v(" "),t("li",[t("p",[s._v("尽量避免在 where 子句中使用 "),t("code",[s._v("!=")]),s._v(" 或 "),t("code",[s._v("<>")]),s._v(" 操作符，避免在 where 子句中对字段进行 null 值判断（可以设置默认值0），否则引擎将放弃使用索引而进行全表扫描。")])]),s._v(" "),t("li",[t("p",[s._v("应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如："),t("code",[s._v("select id from t where num is null")]),s._v(" 可以在 num 上设置默认值 0，确保 num 别没有 null 值，如何这样查询："),t("code",[s._v("select id from t where num = 0")]),s._v("。")])])]),s._v(" "),t("h2",{attrs:{id:"_5-优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-优化"}},[s._v("#")]),s._v(" 5. 优化")]),s._v(" "),t("p",[s._v("做 MySQL 优化，我们要善用 EXPLAIN 查看 SQL 执行计划。主要查看的字段：")]),s._v(" "),t("ul",[t("li",[s._v("type：优化 sql 的重要字段，是判断 sql 性能和优化程度重要指标\n"),t("ul",[t("li",[s._v("执行效率 system > const > eq_ref > ref > range > index > ALL")]),s._v(" "),t("li",[s._v("优化目标至少达到 range 级")])])]),s._v(" "),t("li",[s._v("key：真正走的索引，无索引就是 null")]),s._v(" "),t("li",[s._v("rows：读取的数据量，越少越优")])])])}),[],!1,null,null,null);t.default=r.exports}}]);